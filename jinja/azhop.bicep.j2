@description('Admin user for the Virtual Machines.')
param adminUser string

@description('SSH Key for the Virtual Machines.')
@secure()
param adminSshKey string

@description('The Windows/Active Directory password.')
@secure()
param adminPassword string

@description('Azure region to use')
param location string = resourceGroup().location

// end with a character (x) - requirement for shared image gallery
var resourcePostfix = '${uniqueString(subscription().subscriptionId, resourceGroup().id)}x'

{%- if slurm.accounting_enabled == true %}
@description('Slurm accounting admin user')
param slurmAccountingAdminUser string = 'sqladmin'

@description('Password for the Slurm accounting admin user')
@secure()
param slurmAccountingAdminPassword string
{%- endif %}

//  _   _   ____     ____
// | \ | | / ___|   / ___|
// |  \| | \___ \  | |  _
// | |\  |  ___) | | |_| |
// |_| \_| |____/   \____|
resource commonNsg 'Microsoft.Network/networkSecurityGroups@2020-06-01' = {
  name: 'nsg-common'
  location: location
  properties: {
    securityRules: [
{%- set _throwaway = _nsg_rules.update(bastion_nsg_rules) %}
{%- for rule_name, rule in _nsg_rules.items() %}
      {
        name: '{{ rule_name}}'
        properties: {
          priority: {{ rule[0] }}
          direction: '{{ rule[1] }}'
          access: '{{ rule[2] }}'
          protocol: '{{ rule[3] }}'
          sourcePortRange: '*'
          destinationPortRanges: [
  {%- for port in nsg_destination_ports[rule[4]] %}
            '{{ port }}'
  {%- endfor %}
          ]

  {%- if rule[5].startswith('tag/') %}
          sourceAddressPrefix: '{{ rule[5].split('/')[1] }}'
  {%- endif %}
  {%- if rule[5].startswith('asg/') %}
          sourceApplicationSecurityGroups: [
            {
              id: {{ rule[5].split('/')[1] | replace('-', '_') }}.id
            }
          ]
  {%- endif %}
  {%- if rule[5].startswith('subnet/') %}
          sourceAddressPrefix: '{{ vnet.subnets[rule[5].split('/')[1]].cidr }}'
  {%- endif %}

  {%- if rule[6].startswith('tag/') %}
          destinationAddressPrefix: '{{ rule[6].split('/')[1] }}'
  {%- endif %}
  {%- if rule[6].startswith('asg/') %}
          destinationApplicationSecurityGroups: [
            {
              id: {{ rule[6].split('/')[1] | replace('-', '_') }}.id
            }
          ]
  {%- endif %}
  {%- if rule[6].startswith('subnet/') %}
          destinationAddressPrefix: '{{ vnet.subnets[rule[6].split('/')[1]].cidr }}'
  {%- endif %}
        }
      }
{%- endfor %}
    ]
  }
}

//  _   _   _____   _____  __        __   ___    ____    _  __
// | \ | | | ____| |_   _| \ \      / /  / _ \  |  _ \  | |/ /
// |  \| | |  _|     | |    \ \ /\ / /  | | | | | |_) | | ' /
// | |\  | | |___    | |     \ V  V /   | |_| | |  _ <  | . \
// |_| \_| |_____|   |_|      \_/\_/     \___/  |_| \_\ |_|\_\
resource virtualNetwork 'Microsoft.Network/virtualNetworks@2020-05-01' = {
  name: '{{ vnet.name }}'
  location: location
{%- if 'tags' in vnet %}
  tags: {
    {%- for tag, value in vnet.tags.items() %}
      '{{ tag }}': '{{ value }}'
    {%- endfor %}
  }
{%- endif %}
  properties: {
    addressSpace: {
      addressPrefixes: [
        '{{ vnet.cidr }}'
      ]
    }
    subnets: [
{%- for _, subnet in vnet.subnets.items() %}
      {
        name: '{{ subnet.name }}'
        properties: {
          addressPrefix: '{{ subnet.cidr }}'
  {%- if subnet.get('apply_nsg', true) == true %}
          networkSecurityGroup: {
            id: commonNsg.id
          }
  {%- endif %}
  {%- if 'delegation' in subnet %}
          delegations: [
            {
              name: '{{ subnet.name }}'
              properties: {
                serviceName: '{{ subnet.delegation }}'
              }
            }
          ]
  {%- endif %}
  {%- if 'service_endpoints' in subnet %}
          serviceEndpoints: [
    {%- for endpoint in subnet.service_endpoints %}
            {
              service: '{{ endpoint }}'
            }
    {%- endfor %}
          ]
  {%- endif %}
        }
      }
{%- endfor %}
    ]
  }
}
{%- for subnetName, subnet in vnet.subnets.items() %}
resource {{ subnetName }}Subnet 'Microsoft.Network/virtualNetworks/subnets@2020-05-01' existing = {
  parent: virtualNetwork
  name: '{{ subnet.name }}'
}
{%- endfor %}

//     _      ____     ____
//    / \    / ___|   / ___|
//   / _ \   \___ \  | |  _
//  / ___ \   ___) | | |_| |
// /_/   \_\ |____/   \____|
{% for asg in asgs %}
resource {{ asg | replace('-', '_') }} 'Microsoft.Network/applicationSecurityGroups@2021-08-01' = {
  name: '{{ asg }}'
  location: location
}
{%- endfor %}

// __     __  __  __
// \ \   / / |  \/  |  ___
//  \ \ / /  | |\/| | / __|
//   \ V /   | |  | | \__ \
//    \_/    |_|  |_| |___/
{% for vm_name, vm in vms.items() %}
  {%- if 'identity' in vm %}
resource {{ vm_name | replace('-', '_') }}ManagedIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2018-11-30' = {
  name: '{{ vm_name }}-mi'
  location: location
}
    {%- if 'roles' in vm.identity %}
      {%- for role in vm.identity.roles %}
        {%- if role == 'Contributor' %}
var {{ vm_name }}{{ role }}Id = resourceId('microsoft.authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')
        {%- elif role == 'UserAccessAdministrator' %}
var {{ vm_name }}{{ role }}Id = resourceId('microsoft.authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')
        {%- endif %}
var {{ vm_name }}{{ role }}Ra = guid({{ vm_name }}ManagedIdentity.name, {{ vm_name }}{{ role }}Id, subscription().id)
resource {{ vm_name | replace('-', '_') }}ManagedIdentity{{ role }} 'Microsoft.Authorization/roleAssignments@2020-04-01-preview' = {
  name: {{ vm_name }}{{ role }}Ra
  scope: resourceGroup()
  properties: {
    roleDefinitionId: {{ vm_name }}{{ role }}Id
    principalId: {{ vm_name }}ManagedIdentity.properties.principalId
    principalType: 'ServicePrincipal'
  }
}
      {%- endfor %}
    {%- endif %}
  {%- endif %}


  {% for idx in range(1, vm.get('count', 1)+1) %}
    {%- if 'count' in vm %}
      {%- set vmname = vm_name ~ '-' ~ idx %}
    {%- else %}
      {%- set vmname = vm_name %}
    {%- endif %}

output {{ vmname | replace('-', '_') }}_private_ip string = {{ vmname | replace('-', '_') }}Nic.properties.ipConfigurations[0].properties.privateIPAddress

resource {{ vmname | replace('-', '_') }}Nic 'Microsoft.Network/networkInterfaces@2020-06-01' = {
  name: '{{ vmname }}-nic'
  location: location
  properties: {
    ipConfigurations: [
      {
        name: '{{ vmname }}-ipconfig'
        properties: {
          applicationSecurityGroups: [
    {%- for asg in vm.asgs %}
            {
              id: {{ asg | replace('-', '_') }}.id
            }
    {%- endfor %}
          ]
          subnet: {
            id: {{ vm.subnet }}Subnet.id
          }
          privateIPAllocationMethod: 'Dynamic'
  {%- if 'pip' in vm and vm.pip == true %}
          publicIPAddress: {
            id: {{ vmname | replace('-', '_') }}Pip.id
          }
  {%- endif %}
        }
      }
    ]
  }
}

    {%- if 'pip' in vm and vm.pip == true %}
resource {{ vmname | replace('-', '_') }}Pip 'Microsoft.Network/publicIPAddresses@2021-05-01' = {
  name: '{{ vmname }}-pip'
  location: location
  sku: {
    name: 'Basic'
  }
  properties: {
    publicIPAllocationMethod: 'Dynamic'
    publicIPAddressVersion: 'IPv4'
    idleTimeoutInMinutes: 4
  }
}
    {%- endif %}

resource {{ vmname | replace('-', '_') }}Vm 'Microsoft.Compute/virtualMachines@2020-06-01' = {
  name: '{{ vmname }}'
  location: location
      {%- if 'plan' in images[vm.image] and images[vm.image].plan == true %}
  plan: {
    publisher: '{{ images[vm.image].publisher }}'
    product: '{{ images[vm.image].offer }}'
    name: '{{ images[vm.image].sku }}'
  }
    {%- endif %}
    {%- if 'identity' in vm %}
  identity: {
    type: 'UserAssigned'
    userAssignedIdentities: {
      '${ {{ vm_name | replace('-', '_') }}ManagedIdentity.id}': {}
    }
  }
    {%- endif %}  
  properties: {
    hardwareProfile: {
      vmSize: '{{ vm.sku }}'
    }
    storageProfile: {
    {%- if 'datadisks' in vm %}
      dataDisks: [
      {%- for disk in vm.datadisks %}
        {
          name: '{{ disk.name }}'
          managedDisk: {
            storageAccountType: '{{ disk.disksku }}'
          }
          diskSizeGB: {{ disk.size }}
        {%- if 'caching' in disk %}
          caching: '{{ disk.caching }}'
        {%- endif %}
          lun: {{ loop.index0 }}
          createOption: 'Empty'
        }
      {%- endfor %}
      ]
    {%- endif %}
      osDisk: {
        createOption: 'FromImage'
        managedDisk: {
          storageAccountType: '{{ vm.osdisksku }}'
        }
    {%- if 'osdisksize' in vm %}
        diskSizeGB: {{ vm.osdisksize }}
    {%- endif %}
        caching: 'ReadWrite'
      }
      imageReference: {
        publisher: '{{ images[vm.image].publisher }}'
        offer: '{{ images[vm.image].offer }}'
        sku: '{{ images[vm.image].sku }}'
        version: '{{ images[vm.image].version }}'
      }
    }
    networkProfile: {
      networkInterfaces: [
        {
          id: {{ vmname | replace('-', '_') }}Nic.id
        }
      ]
    }
    osProfile: {
      computerName: '{{ vmname }}'
      adminUsername: adminUser
    {%- if 'windows' in vm and vm.windows == true %}
      adminPassword: adminPassword
      windowsConfiguration: {
        winRM: {
          listeners: [
            {
              protocol: 'Http'
            }
          ]
        }
      }
    {%- else %}
      linuxConfiguration: {
        disablePasswordAuthentication: true
        ssh: {
          publicKeys: [
            {
              path: '/home/${adminUser}/.ssh/authorized_keys'
              keyData: adminSshKey
            }
          ]
        }
      }
    {%- endif %}
    }
    {%- if 'ahub' in vm and vm.ahub == true %}
    licenseType: 'Windows_Server'
    {%- endif %}
  }
}
  {%- endfor %}
{%- endfor %}

//     _      _   _   _____
//    / \    | \ | | |  ___|
//   / _ \   |  \| | | |_
//  / ___ \  | |\  | |  _|
// /_/   \_\ |_| \_| |_|

resource anfAccount 'Microsoft.NetApp/netAppAccounts@2021-10-01' = {
  name: 'azhop-${resourcePostfix}'
  location: location
  
{%- if anf.dual_protocol == true %}
  properties: {
    activeDirectories: [
      {
        username: adminUser
        password: adminPassword
        dns: adNic.properties.ipConfigurations[0].properties.privateIPAddress
        smbServerName: 'anf'
        domain: 'hpc.azure' 
      }
    ]
  }
{%- endif %}
}

resource anfPool 'Microsoft.NetApp/netAppAccounts/capacityPools@2021-10-01' = {
  name: 'anfpool-${resourcePostfix}'
  location: location
  parent: anfAccount
  properties: {
    serviceLevel: '{{ anf.service_level }}'
    size: {{ anf.size_tb * 1024 * 1024 * 1024 * 1024 }}
  }
}

resource anfHome 'Microsoft.NetApp/netAppAccounts/capacityPools/volumes@2021-10-01' = {
  name: 'anfhome'
  location: location
  parent: anfPool
  properties: {
    creationToken: 'home-${resourcePostfix}'
    serviceLevel: '{{ anf.service_level }}'
    subnetId: netappSubnet.id
    protocolTypes: [
      'NFSv3'
{%- if anf.dual_protocol == true %}
      'CIFS'
{%- endif %}
    ]
    securityStyle: 'unix'
    usageThreshold: {{ anf.size_tb * 1024 * 1024 * 1024 * 1024 }}

    exportPolicy: {
      rules: [
        {
          ruleIndex: 1
          allowedClients: '0.0.0.0/0'
          unixReadWrite: true
          hasRootAccess: true
          nfsv3: true
        }
      ]
    }
  }
}

output anf_home_ip string = anfHome.properties.mountTargets[0].ipAddress

//  ____    ___    ____
// / ___|  |_ _|  / ___|
// \___ \   | |  | |  _
//  ___) |  | |  | |_| |
// |____/  |___|  \____|

resource sig 'Microsoft.Compute/galleries@2022-01-03' = {
  name: 'azhop_${resourcePostfix}'
  location: location
  properties: {
    description: 'Shared images for AZHOP"'
  }
}

//  _  __  _____  __   __ __     __     _      _   _   _       _____
// | |/ / | ____| \ \ / / \ \   / /    / \    | | | | | |     |_   _|
// | ' /  |  _|    \ V /   \ \ / /    / _ \   | | | | | |       | |
// | . \  | |___    | |     \ V /    / ___ \  | |_| | | |___    | |
// |_|\_\ |_____|   |_|      \_/    /_/   \_\  \___/  |_____|   |_|

resource kv 'Microsoft.KeyVault/vaults@2021-10-01' = {
  name: 'kv${resourcePostfix}'
  location: location
  properties: {
    enabledForDiskEncryption: true
    tenantId: subscription().tenantId
    softDeleteRetentionInDays: 7
    sku: {
      family: 'A'
      name: 'standard'
    }
    networkAcls: {
      bypass: 'AzureServices'
{%- if lock_down_network.enforce == true %}
      defaultAction: 'Deny'
{%- else %}
      defaultAction: 'Allow'
{%- endif %}
{%- if 'grant_access_from' in lock_down_network %}
      ipRules: [
  {%- for ip in lock_down_network.grant_access_from %}
        {
          value: '{{ ip }}'
        }
  {%- endfor %}
      ]
{%- endif %}
      virtualNetworkRules: [
        {
          id: adminSubnet.id
        }
      ]
    }
    accessPolicies: [
{%- for oid in keyvault_readers %}
      {
        objectId: '{{ oid }}'
        permissions: {
          secrets: [
            'Get'
            'List'
          ]
        }
        tenantId: subscription().tenantId
      }
{%- endfor %}
{%- for vm_name, vm in vms.items() %}
  {%- if 'identity' in vm and 'keyvault' in vm.identity %}
      {
        objectId: {{ vm_name | replace('-', '_') }}ManagedIdentity.properties.principalId
        permissions: {
    {%- if 'key_permissions' in vm.identity.keyvault %}
          keys: [
      {%- for perm in vm.identity.keyvault.key_permissions %}
            '{{ perm }}'
      {%- endfor %}
          ]
    {%- endif %}
    {%- if 'secret_permissions' in vm.identity.keyvault %}
          secrets: [
      {%- for perm in vm.identity.keyvault.secret_permissions %}
            '{{ perm }}'
      {%- endfor %}
          ]
    {%- endif %}
        }
        tenantId: subscription().tenantId
      }
  {%- endif %}
{%- endfor %}
    ]
  }
}

resource adminPasswordSecret 'Microsoft.KeyVault/vaults/secrets@2021-10-01' = {
  name: '${adminUser}-password'
  parent: kv
  properties: {
    value: adminPassword
  }
}


//  ____    _____    ___    ____       _       ____   _____
// / ___|  |_   _|  / _ \  |  _ \     / \     / ___| | ____|
// \___ \    | |   | | | | | |_) |   / _ \   | |  _  |  _|
//  ___) |   | |   | |_| | |  _ <   / ___ \  | |_| | | |___
// |____/    |_|    \___/  |_| \_\ /_/   \_\  \____| |_____|
//
// Storage account used for
//  - CycleCloud projects
//  - Terraform states
resource storageAccount 'Microsoft.Storage/storageAccounts@2021-09-01' = {
  name: 'azhop${resourcePostfix}'
  location: location
  sku: {
    name: 'Standard_LRS'
  }
  kind: 'StorageV2'
  properties: {
    accessTier: 'Hot'
    minimumTlsVersion: 'TLS1_2'
{%- if lock_down_network.enforce == true %}
    networkAcls: {
      defaultAction: 'Deny'
      ipRules: [
  {%- for ip in lock_down_network.grant_access_from %}
        {
          value: '{{ ip }}'
        }
  {%- endfor %}
      ]
      virtualNetworkRules: [
        {
          id: adminSubnet.id
        }
        {
          id: computeSubnet.id
        }
      ]
    }
{%- endif %}
  }
}

resource blobServices 'Microsoft.Storage/storageAccounts/blobServices@2021-09-01' = {
  name: 'default'
  parent: storageAccount
}

resource lustreArchive 'Microsoft.Storage/storageAccounts/blobServices/containers@2021-06-01' = {
  name: 'lustre'
  parent: blobServices
  properties: {
    publicAccess: 'None'
  }
}

//  __  __  __   __  ____     ___    _
// |  \/  | \ \ / / / ___|   / _ \  | |
// | |\/| |  \ V /  \___ \  | | | | | |
// | |  | |   | |    ___) | | |_| | | |___
// |_|  |_|   |_|   |____/   \__\_\ |_____|
{%- if slurm.accounting_enabled == true %}
resource mysql 'Microsoft.DBforMySQL/servers@2017-12-01' = {
  name: 'azhop-${resourcePostfix}'
  location: location
  
  sku: {
    name: 'GP_Gen5_2'
  }
  properties: {
    minimalTlsVersion: 'TLS1_2'
    publicNetworkAccess: 'Enabled'
    sslEnforcement: 'Enabled'
    storageProfile: {
      backupRetentionDays: 7
      geoRedundantBackup: 'Disabled'
      storageAutogrow: 'Enabled'
      storageMB: 5120
    }
    version: '5.7'
    createMode: 'Default'
    administratorLogin: slurmAccountingAdminUser
    administratorLoginPassword: slurmAccountingAdminPassword
  }
}

resource mysqlAdmin 'Microsoft.DBforMySQL/servers/virtualNetworkRules@2017-12-01' = {
  name: 'AllowAccessAdmin'
  parent: mysql
  properties: {
    virtualNetworkSubnetId: adminSubnet.id
  }
}

resource mysqlFrontend 'Microsoft.DBforMySQL/servers/virtualNetworkRules@2017-12-01' = {
  name: 'AllowAccessFrontend'
  parent: mysql
  properties: {
    virtualNetworkSubnetId: frontendSubnet.id
  }
}

resource mysqlPasswordSecret 'Microsoft.KeyVault/vaults/secrets@2021-10-01' = {
  name: '${slurmAccountingAdminUser}-password'
  parent: kv
  properties: {
    value: slurmAccountingAdminPassword
  }
}
{%- endif %}


//  ____       _      ____    _____   ___    ___    _   _
// | __ )     / \    / ___|  |_   _| |_ _|  / _ \  | \ | |
// |  _ \    / _ \   \___ \    | |    | |  | | | | |  \| |
// | |_) |  / ___ \   ___) |   | |    | |  | |_| | | |\  |
// |____/  /_/   \_\ |____/    |_|   |___|  \___/  |_| \_|

resource bastionPip 'Microsoft.Network/publicIpAddresses@2020-08-01' = {
  name: 'bastion-pip'
  location: location
  sku: {
    name: 'Standard'
  }
  properties: {
    publicIPAllocationMethod: 'Static'
  }
}

resource bastionHost 'Microsoft.Network/bastionHosts@2021-08-01' = {
  name: 'bastion'
  location: location
  sku: {
    name: 'Standard'
  }
  properties: {
    enableTunneling: true
    ipConfigurations: [
      {
        name: 'bastion-ipconfig'
        properties: {
          subnet: {
            id: bastionSubnet.id
          }
          publicIPAddress: {
            id: bastionPip.id
          }
        }
      }
    ]
  }
}

//   ___    _   _   _____   ____    _   _   _____   ____
//  / _ \  | | | | |_   _| |  _ \  | | | | |_   _| / ___|
// | | | | | | | |   | |   | |_) | | | | |   | |   \___ \
// | |_| | | |_| |   | |   |  __/  | |_| |   | |    ___) |
//  \___/   \___/    |_|   |_|      \___/    |_|   |____/

output resource_postfix string = resourcePostfix
output subscription_id string = subscription().subscriptionId
output tenant_id string = subscription().tenantId
output environment_name string = environment().name
output keyvault_suffix string = environment().suffixes.storage
output storage_suffix string = environment().suffixes.storage
output location string = location
output resource_group string = resourceGroup().name