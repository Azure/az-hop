- hosts: ondemand
  #gather_facts: no
  become: true
  tasks:
  - include_role:
      name : ood-ansible
  - name: Disable SELinux
    ansible.posix.selinux:
      state: disabled 
  - name: Install Apache PAM module
    yum:
      name: mod_authnz_pam
  - name: Copy PAM module to SCL Apache module directory
    file:
      src: /usr/lib64/httpd/modules/mod_authnz_pam.so
      dest: /opt/rh/httpd24/root/usr/lib64/httpd/modules/mod_authnz_pam.so
      state: link
  - name: Enable the PAM module
    copy:
      content: "LoadModule authnz_pam_module modules/mod_authnz_pam.so"
      dest: /opt/rh/httpd24/root/etc/httpd/conf.modules.d/55-authnz_pam.conf
  - name: Set the PAM service
    file:
      src: /etc/pam.d/sshd
      dest: /etc/pam.d/ood
      state: link
  - name: Allow apache to read etc shadow
    file:
      path: /etc/shadow
      group: apache
      mode: '0640'
  - name: update ood portal
    shell: "/opt/ood/ood-portal-generator/sbin/update_ood_portal --force"
    ignore_errors: yes
  - name: restart apache httpd
    systemd:
      name: httpd24-httpd
      state: restarted
      enabled: true
  - name: restart httpd htcacheclean
    systemd:
      name: httpd24-htcacheclean
      state: restarted