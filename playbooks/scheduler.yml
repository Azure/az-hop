---
# Do not assume the inventory_hostname is resolvable and delay 10 seconds at start
- name: wait for host to be available
  hosts: scheduler
  tasks:
  - name: Wait 300 seconds for port 22 to become open and contain "OpenSSH"
    wait_for:
      port: 22
      host: '{{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }}'
      search_regex: OpenSSH
      delay: 10
    connection: local

- hosts: scheduler
  become: true
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - name: Read Password from KV
    command: az keyvault secret show --vault-name {{key_vault}} -n {{admin_user}}-password --query "value" -o tsv
    delegate_to: localhost
    connection: local
    register: password
    become: false

  - include_role: 
      name: pbsserver
      apply: 
        become: true
    vars:
      cc_admin: '{{admin_user}}'
      cc_password: '{{password.stdout}}'
      cc_pbs_version: 1.4.0
    when: (queue_manager == "openpbs" or queue_manager is not defined)

  - include_role: 
      name: munge
      apply: 
        become: true
    when: queue_manager == "slurm"

  - include_role: 
      name: slurmserver
      apply: 
        become: true
    vars:
      cc_admin: '{{admin_user}}'
      cc_password: '{{password.stdout}}'
      slurm_version: 20.11.7-1
      accounting_enabled: '{{slurm.accounting_enabled | default(false)}}'
    when: queue_manager == "slurm"
