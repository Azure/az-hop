---
# This looks crazy but in order for this playbook to run from a pipeline, the jumpbox dummy need to be added
# - name: jumpbox dummy
#   hosts: jumpbox
#   become: true
#   vars_files:
#     - '{{global_config_file}}'

# Do not assume the inventory_hostname is resolvable and delay 10 seconds at start
- name: wait for host to be available
  hosts: ccportal
  tasks:
  - name: Wait 300 seconds for port 22 to become open and contain "OpenSSH"
    wait_for:
      port: 22
      host: '{{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }}'
      search_regex: OpenSSH
      delay: 10
    connection: local

- name: Setup Cycle Cloud
  hosts: ccportal
  become: true
  vars:
    - ansible_python_interpreter: /usr/bin/python3
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - name: Read Password from KV
    command: az keyvault secret show --vault-name {{key_vault}} -n {{admin_user}}-password --query "value" -o tsv
    delegate_to: localhost
    connection: local
    register: password
    become: false

  - include_role: 
      name: cyclecloud
      apply: 
        become: true
    vars:
      cc_admin_user: '{{admin_user}}'
      cc_public_key: '{{global_ssh_public_key}}'
      cc_password: '{{password.stdout}}'
      cc_storage: '{{global_cc_storage}}'
      cc_domain: '{{ad_join_domain}}'
      cc_ad_server: '{{ldap_server}}'
      cc_rpms_jetpack: '{{ cyclecloud.rpms.jetpack | default(None) }}'
      cc_rpms_cycle: '{{ cyclecloud.rpms.cyclecloud | default(None) }}'
