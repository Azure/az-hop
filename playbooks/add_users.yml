---
- name: prep socks tunnel
  hosts: localhost
  connection: local
  gather_facts: no
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - name: start socks tunnel  
    shell: ssh -i {{ lookup('env', 'PWD') }}/{{ansible_ssh_private_key_file}} -fN -D localhost:5985 -o StrictHostKeyChecking=no {{admin_user}}@{{ psrp_ssh_proxy }}

- name: Add domain users
  hosts: ad
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - include: create_user.yml user="{{item}}"
    with_items: "{{users}}"

- name: close socks tunnel
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
  - name: close session on local port
    shell: ps aux | grep 5985 | grep ssh | awk '{print "kill -9 " $2}' | sh
    ignore_errors: true

- name: Configure Users
  hosts: jumpbox
  become: true
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - name: init user context for {{item.name}}
    command: ssh-keygen -t rsa -f ~/.ssh/id_rsa -q -N ""
    become_user: '{{item.name}}'
    args: 
      creates: "{{item.home}}/.ssh/id_rsa"
    with_items: "{{users}}"

  - name: Copy file with owner and permissions
    copy:
      src: "{{item.home}}/.ssh/id_rsa.pub"
      dest: "{{item.home}}/.ssh/authorized_keys"
      remote_src: yes
      mode: '0600'
      owner: '{{item.name}}'
      group: "domain users" 
      force: no
    with_items: "{{users}}"
