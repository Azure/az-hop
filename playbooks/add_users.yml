---
- name: prep socks tunnel
  hosts: localhost
  connection: local
  gather_facts: no
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - name: start socks tunnel  
    shell: ssh -i {{ lookup('env', 'PWD') }}/{{ansible_ssh_private_key_file}} -fN -D localhost:5985 -o StrictHostKeyChecking=no {{admin_user}}@{{ psrp_ssh_proxy }}

- name: Add domain users
  hosts: ad
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - name: Read Password from KV
    command: az keyvault secret show --vault-name {{key_vault}} -n {{admin_user}}-password --query "value" -o tsv
    delegate_to: 127.0.0.1
    register: password
    become: false
    run_once: true

  - name: add users
    community.windows.win_domain_user:
      name: "{{ item.name }}"
      firstname: "{{ item.name }}"
      password: '{{password.stdout}}' 
      state: present
      groups:
        - Domain Users
        - Domain Admins
      attributes:
        uidNumber: "{{ item.uid }}"
        uid: "{{ item.name }}"
        loginShell: "{{ item.shell }}"
        unixhomedirectory: "{{ item.home }}"
        gidnumber: "{{item.gid}}"
    with_items: "{{users}}"

- name: close socks tunnel
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
  - name: close session on local port
    shell: ps aux | grep 5985 | grep ssh | awk '{print "kill -9 " $0}'

- name: Configure Users
  hosts: jumpbox
  become: true
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - name: init user context for {{item.name}}
    command: ssh-keygen -t rsa -f ~/.ssh/id_rsa -q -N ""
    become_user: '{{item.name}}'
    args: 
      creates: "{{item.home}}/.ssh/id_rsa"
    with_items: "{{users}}"

  - name: Copy file with owner and permissions
    copy:
      src: "{{item.home}}/.ssh/id_rsa.pub"
      dest: "{{item.home}}/.ssh/authorized_keys"
      remote_src: yes
      mode: '0600'
      owner: '{{item.name}}'
      group: "domain users" 
      force: no
    with_items: "{{users}}"
