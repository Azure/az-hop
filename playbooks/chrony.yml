- hosts: ondemand 
  become: true
  vars_files:
    - '{{global_config_file}}'
  
  tasks:
  - name: set main chrony conf file
    copy:
      dest: /etc/chrony.conf
      mode: 0644
      content: |
        server 0.centos.pool.ntp.org iburst
        server 1.centos.pool.ntp.org iburst
        server 2.centos.pool.ntp.org iburst
        server 3.centos.pool.ntp.org iburst
        driftfile /var/lib/chrony/drift
        makestep 1.0 -1
        rtcsync
        allow 10.0.0.0/16
        logdir /var/log/chrony
        refclock PHC /dev/ptp_hyperv poll 3 dpoll -2 offset 0
  - name: enable and start chronyd
    service:
      name: chronyd
      enabled: yes
      state: started

# chrony.conf for different OS versions https://docs.microsoft.com/en-us/azure/virtual-machines/linux/time-sync
- hosts: jumpbox, scheduler, lustre, lustre-oss-*, robinhood, grafana, ccportal
  become: true
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - name: check if /dev/ptp_hyperv file exists
    stat: 
      path: /dev/ptp_hyperv
    register: ptp_hyperv

  - name: set node chrony conf file
    copy:
      dest: /etc/chrony.conf
      mode: 0644
      content: |
        server ondemand
        driftfile /var/lib/chrony/drift
        makestep 1.0 -1
        rtcsync
        logdir /var/log/chrony
        refclock PHC /dev/ptp_hyperv poll 3 dpoll -2 offset 0
    when: ptp_hyperv.stat.exists == True

  - name: set node chrony conf file
    copy:
      dest: /etc/chrony.conf
      mode: 0644
      content: |
        server ondemand
        driftfile /var/lib/chrony/drift
        makestep 1.0 -1
        rtcsync
        logdir /var/log/chrony
        refclock PHC /dev/ptp0 poll 3 dpoll -2 offset 0
    when: ptp_hyperv.stat.exists == False

  - name: enable and start chronyd
    service:
      name: chronyd
      enabled: yes
      state: started
