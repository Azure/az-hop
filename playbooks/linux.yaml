---
- name: Join AD domain and mount anf-home
  hosts: jumpbox, scheduler, ondemand
  become: true

  tasks:
  - name: Install dependencies
    yum:
      name: epel-release, sssd, realmd, oddjob, oddjob-mkhomedir, adcli, samba-common, samba-common-tools, krb5-workstation, openldap-clients, policycoreutils-python, nfs-utils 
  - name: Disable SELinux
    ansible.posix.selinux:
      state: disabled
  - name: Restart service dbus
    service:
      name: dbus
      state: restarted 
  - name: Restart service systemd-logind
    service:
      name: systemd-logind
      state: restarted
  - name: create dhclient config
    copy:
      content: "supersede domain-name-servers {{ ad_dns }};\nappend domain-name-servers 168.63.129.16;"
      dest: "/etc/dhcp/dhclient.conf"
  - name: Restart service network
    service:
      name: NetworkManager
      state: restarted
  - name: Creates home directory mountpoint
    file:
      path: /anfhome
      state: directory
      mode: 0755
  - name: Mount an NFS volume
    ansible.posix.mount:
      src: '{{ anf_home_ip }}:/{{ anf_home_path }}'
      path: /anfhome
      opts: rw,sync,hard,intr
      state: mounted
      fstype: nfs
  - name: Update ANF chmod mode
    file:
      path: /anfhome
      state: directory
      mode: '0777'
    run_once : true
  - name: check if sssd.conf file exists
    stat: 
      path: /etc/sssd/sssd.conf
    register: sssd_conf
  - name: Join AD domain
    shell: echo {{ ad_join_password }} | realm join -U {{ ad_join_user }} {{ ad_join_domain }}
    when: sssd_conf.stat.exists == false
  - name: configure sssd
    lineinfile:
      path: /etc/sssd/sssd.conf
      regexp: '^use_fully_qualified_names'
      line: 'use_fully_qualified_names = False'
  - name: configure sssd
    lineinfile:
      path: /etc/sssd/sssd.conf
      regexp: '^ldap_id_mapping'
      line: 'ldap_id_mapping = False'
  - name: Restart sssd
    service:
      name: sssd 
      state: restarted
