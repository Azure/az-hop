- name: Read Password from KV
  command: az keyvault secret show --vault-name {{key_vault}} -n {{user.name}}-password --query "value" -o tsv
  delegate_to: localhost
  connection: local
  register: password
  become: false

- name: add user
  community.windows.win_domain_user:
    name: "{{ user.name }}"
    firstname: "{{ user.name }}"
    password: '{{password.stdout}}'
    password_never_expires: true
    state: present
    groups:
      - Domain Users
    attributes:
      uidNumber: "{{ user.uid }}"
      uid: "{{ user.name }}"
      loginShell: "{{ user.shell }}"
      unixhomedirectory: "{{ user.home }}"
      gidnumber: "{{user.gid}}"

- name: add Admin
  community.windows.win_domain_user:
    name: "{{ user.name }}"
    firstname: "{{ user.name }}"
    password: '{{password.stdout}}'
    password_never_expires: true
    state: present
    groups:
      - Domain Admins
    attributes:
      uidNumber: "{{ user.uid }}"
      uid: "{{ user.name }}"
      loginShell: "{{ user.shell }}"
      unixhomedirectory: "{{ user.home }}"
      gidnumber: "{{user.gid}}"
  when: user.admin
