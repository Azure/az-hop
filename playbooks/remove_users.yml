---
- name: prep socks tunnel
  hosts: localhost
  connection: local
  gather_facts: no
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - name: start socks tunnel  
    shell: ssh -i {{ lookup('env', 'PWD') }}/{{ansible_ssh_private_key_file}} -fN -D localhost:5985 -p {{jumpbox_ssh_port}} -p {{jumpbox_ssh_port}} -o StrictHostKeyChecking=no {{admin_user}}@{{ psrp_ssh_proxy }}
    when: (jumpbox is defined)

- name: Remove azhop-users
  hosts: ad
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - name: Remove users
    community.windows.win_domain_user:
      name: "{{ item.name }}"
      state: absent
    with_items: '{{users}}'
    when: users is defined

- name: close socks tunnel
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
  - name: close session on local port
    shell: ps aux | grep localhost:5985 | grep -v grep | awk '{print "kill -9 " $2}' | sh
    ignore_errors: true
    when: (jumpbox is defined)

- name: Remove Users
  hosts: ondemand
  become: true
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - include: remove_homedir.yml user="{{item}}"
    with_items: '{{users}}'
    when: users is defined
