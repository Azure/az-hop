---
- name: prep socks tunnel
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
  - name: start socks tunnel  
    shell: ssh -i {{ lookup('env', 'PWD') }}/{{ansible_ssh_private_key_file}} -fN -D localhost:5985 -o StrictHostKeyChecking=no ${ansible_user}@{{ psrp_ssh_proxy }}

- name: Configure AD Server
  hosts: ad

  tasks:
  - name: Install AD-Domain-Services
    win_feature:
      name: AD-Domain-Services
      include_management_tools: yes
      include_sub_features: yes
      state: present

  - name: Create AD-Domain
    ansible.windows.win_domain:
      dns_domain_name: hpc.azure
      safe_mode_password: '{{ad_join_password}}'
    register: ad_promotion

  - name: Reboot after promotion
    ansible.windows.win_reboot:
      post_reboot_delay: 600
    when: ad_promotion.reboot_required

  - name: Ensure user hugo is present
    community.windows.win_domain_user:
      name: hugo
      firstname: hugo
      password: '{{ad_join_password}}'
      state: present
      groups:
        - Domain Users
        - Domain Admins
      attributes:
        uidNumber: 10001 
        uid: hugo
        loginShell: /bin/bash
        unixhomedirectory: /anfhome/hugo
        gidnumber: 5000 

  - name: Ensure user xavier is present
    community.windows.win_domain_user:
      name: xavier
      firstname: xavier
      password: '{{ad_join_password}}' 
      state: present
      groups:
        - Domain Users
        - Domain Admins
      attributes:
        uidNumber: 10002 
        uid: xavier
        loginShell: /bin/bash
        unixhomedirectory: /anfhome/xavier
        gidnumber: 5000 

  - name: Ensure user paul is present
    community.windows.win_domain_user:
      name: paul
      firstname: paul
      password: '{{ad_join_password}}' 
      state: present
      groups:
        - Domain Users
        - Domain Admins
      attributes:
        uidNumber: 10003 
        uid: paul
        loginShell: /bin/bash
        unixhomedirectory: /anfhome/paul
        gidnumber: 5000 

  - name: Ensure user domainjoinuser is present
    community.windows.win_domain_user:
      name: domainjoinuser
      firstname: domainjoinuser
      password: '{{ad_join_password}}' 
      state: present
      groups:
        - Domain Users
  - name: update gidnumber Domain Users 
    community.windows.win_domain_group:
      name: Domain Users
      attributes:
        gidnumber: 5000

- name: close socks tunnel
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
  - name: close session on local port
    shell: ps aux | grep 5985 | grep ssh | awk '{print "kill -9 " $0}'

