---
- name: prep socks tunnel
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
  - name: start socks tunnel  
    shell: ssh -i {{ lookup('env', 'PWD') }}/hpcadmin_id_rsa -fN -D localhost:5985 -o StrictHostKeyChecking=no hpcadmin@{{ psrp_ssh_proxy }}

- name: Configure AD Server
  hosts: ad
  tasks:
  - name: Install AD-Domain-Services
    win_feature:
      name: AD-Domain-Services
      include_management_tools: yes
      include_sub_features: yes
      state: present
  - name: Create AD-Domain
    ansible.windows.win_domain:
      dns_domain_name: hpc.azure
      safe_mode_password: password123!
    register: ad_promotion
  - name: Reboot after promotion
    ansible.windows.win_reboot:
      post_reboot_delay: 600
    when: ad_promotion.reboot_required
  - name: add users
    community.windows.win_domain_user:
      name: "{{ item.name }}"
      firstname: "{{ item.name }}"
      password: Microsoft12345! 
      state: present
      groups:
        - Domain Users
        - Domain Admins
      attributes:
        uidNumber: "{{ item.uid }}"
        uid: "{{ item.name }}"
        loginShell: /bin/bash
        unixhomedirectory: /anfhome/"{{ item.name }}"
        gidnumber: 5000
    with_items:
      - { name: hugo, uid: 10001 }
      - { name: paul, uid: 10002 }
      - { name: xavier, uid: 10003 }
  - name: Ensure user domainjoinuser is present
    community.windows.win_domain_user:
      name: domainjoinuser
      firstname: domainjoinuser
      password: Microsoft12345! 
      state: present
      groups:
        - Domain Users
  - name: update gidnumber Domain Users 
    community.windows.win_domain_group:
      name: Domain Users
      attributes:
        gidnumber: 5000

- name: close socks tunnel
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
  - name: close session on local port
    shell: ps aux | grep 5985 | grep ssh | awk '{print "kill -9 " $0}'

