---

- name: install dependencies
  yum:
    name: python3, python3-pip, munge, munge-devel, rpm-build, readline-devel, pam-devel, perl-ExtUtils-MakeMaker, gcc, mariadb-devel

- name: add slurm group 
  group:
    name: slurm
    gid: '{{ slurm_gid }}'
    state: present

- name: add slurm user
  user:
    name: slurm 
    group: slurm
    uid: '{{ slurm_uid }}'
    state: present

- name: check local munge dir
  file:
    path: /etc/munge
    owner: munge
    group: munge
    mode: 0700
    state: directory

- name: check slurm config dir 
  file:
    path: '{{homedir_mountpoint}}/slurm/config/'
    mode: 0755
    owner: slurm 
    group: slurm 
    state: directory

- name: generate munge key
  shell: openssl rand -base64 24 > '{{homedir_mountpoint}}/slurm/config/munge.key'

- name: install munge key
  copy:
    src: '{{homedir_mountpoint}}/slurm/config/munge.key'
    remote_src: yes
    dest: /etc/munge/munge.key
    owner: munge
    group: munge
    mode: 0400

- name: ensure munge is running.
  service:
    name: munge 
    state: restarted
    enabled: yes

- name: check slurm rpm dir 
  file:
    path: '{{homedir_mountpoint}}/slurm/rpms/'
    mode: 0755
    state: directory

- name: check local slurm config dir 
  file:
    path: /etc/slurm/
    mode: 0755
    owner: slurm 
    group: slurm 
    state: directory

- name: create a symbolic link for slurm config dir
  file:
    src: '{{homedir_mountpoint}}/slurm/config'
    dest: /sched
    owner: slurm 
    group: slurm 
    state: link

- name: check slurmctld log dir 
  file:
    path: /var/log/slurmctld/
    mode: 0755
    owner: slurm 
    group: slurm 
    state: directory

- name: check slurmctld log dir 
  file:
    path: /var/spool/slurmd/
    mode: 0755
    owner: slurm 
    group: slurm 
    state: directory

- name: extract slurm tarball version number
  set_fact:
    slurm_version_short: "{{cc_slurm_version | regex_replace('-.*$', '')}}"

- name: check if slurm rpms exist
  stat:
    path: '{{homedir_mountpoint}}/slurm/rpms/slurm-{{cc_slurm_version}}.el7.x86_64.rpm'
  register: slurm_rpms

- name: download slurm 
  get_url:
    url: 'https://download.schedmd.com/slurm/slurm-{{slurm_version_short}}.tar.bz2'
    dest: /mnt/resource
  when: slurm_rpms.stat.exists == False

- name: check slurm build dir 
  file:
    path: /root/rpmbuild
    mode: 0755
    state: directory

- name: build slurm
  shell: |
    rpmbuild --clean -ta /mnt/resource/slurm-{{slurm_version_short}}.tar.bz2 > log.txt
    sudo cp /root/rpmbuild/RPMS/x86_64/slurm-*.rpm {{homedir_mountpoint}}/slurm/rpms/
  args:
    chdir: "{{ ansible_env.HOME }}/rpmbuild"
  when: slurm_rpms.stat.exists == False

- name: check central slurm dir 
  file:
    path: '{{homedir_mountpoint}}/slurm/slurmctld/'
    mode: 0755
    owner: slurm 
    group: slurm 
    state: directory

- name: install slurm 
  yum:
    name:
      -  '{{homedir_mountpoint}}/slurm/rpms/slurm-{{cc_slurm_version}}.el7.x86_64.rpm'
      -  '{{homedir_mountpoint}}/slurm/rpms/slurm-perlapi-{{cc_slurm_version}}.el7.x86_64.rpm'
      -  '{{homedir_mountpoint}}/slurm/rpms/slurm-slurmctld-{{cc_slurm_version}}.el7.x86_64.rpm'
    state: present

- name: create slurm config 
  copy:
    src: files/slurm.conf
    dest: /sched/slurm.conf
    owner: slurm 
    group: slurm 

- name: create slurm cgroup config 
  copy:
    src: files/cgroup.conf
    dest: /sched/cgroup.conf
    owner: slurm 
    group: slurm 

- name: symbolic link for slurm.conf 
  file:
    src: /sched/slurm.conf
    dest: /etc/slurm/slurm.conf
    state: link

- name: symbolic link for cgroup.conf 
  file:
    src: /sched/cgroup.conf
    dest: /etc/slurm/cgroup.conf
    state: link

- name: check slurm autoscale dir 
  file:
    path: /opt/cycle/slurm/
    mode: 0755
    state: directory

- name: download cc autoscale scripts
  get_url:
    url: https://raw.githubusercontent.com/Azure/cyclecloud-slurm/2.5.0/specs/default/chef/site-cookbooks/slurm/files/default/{{ item }}
    dest: /opt/cycle/slurm
  with_items:
    - clusterwrapper.py
    - cyclecloud_nodeinfo.sh
    - cyclecloud_slurm.py
    - cyclecloud_slurm.sh
    - cyclecloud_slurm_test.py
    - resume_fail_program.sh
    - resume_program.sh
    - return_to_idle.sh
    - slurm-limits.conf
    - slurmcc.py
    - slurmcc_test.py
    - slurmctld.override
    - suspend_program.sh
    - terminate_nodes.sh

- name: check execute bit for cyclecloud_slurm.sh 
  file:
    path: /opt/cycle/slurm/cyclecloud_slurm.sh
    mode: 0755
    owner: slurm 
    group: slurm 

- name: check execute bit for return_to_idle.sh 
  file:
    path: /opt/cycle/slurm/return_to_idle.sh
    mode: 0755
    owner: slurm 
    group: slurm 

- name: check execute bit for terminate_nodes.sh 
  file:
    path: /opt/cycle/slurm/terminate_nodes.sh
    mode: 0755
    owner: slurm 
    group: slurm 

- name: check execute bit for resume_fail_program.sh 
  file:
    path: /opt/cycle/slurm/resume_fail_program.sh
    mode: 0700
    owner: slurm 
    group: slurm 

- name: check execute bit for resume_program.sh 
  file:
    path: /opt/cycle/slurm/resume_program.sh
    mode: 0700
    owner: slurm 
    group: slurm 

- name: check execute bit for suspend_program.sh 
  file:
    path: /opt/cycle/slurm/suspend_program.sh
    mode: 0700
    owner: slurm 
    group: slurm 

- name: install jetpack 
  yum:
    name:
    -  https://packages.microsoft.com/yumrepos/cyclecloud/jetpack8-8.2.0-1616.x86_64.rpm
    state: present

- name: fix jetpack permissions
  file:
    path: /opt/cycle/jetpack
    mode: u=rwX,g=rX,o=rX
    recurse: yes

- name: download cc autoscale api 
  get_url:
    url: https://github.com/Azure/cyclecloud-slurm/releases/download/2.5.0/cyclecloud_api-8.1.0-py2.py3-none-any.whl
    dest: /opt/cycle/slurm

- name: download cc jobsubmit plugin
  get_url:
    url: https://github.com/Azure/cyclecloud-slurm/releases/download/2.5.0/job_submit_cyclecloud_ubuntu_20.11.7-1.so
    dest: /usr/lib64/slurm/job_submit_cyclecloud.so

- name: install cc autoscale api 
  shell: |
      /opt/cycle/jetpack/system/embedded/bin/pip install /opt/cycle/slurm/cyclecloud_api-8.1.0-py2.py3-none-any.whl  2>&1
      /opt/cycle/slurm/cyclecloud_slurm.sh initialize --cluster-name slurm1 --username "{{ cc_admin }}" --password "{{ cc_password }}" --url https://ccportal:9443/cyclecloud
  args:
    creates: /opt/cycle/jetpack/config/autoscale.json

- name: create emtpy cyclecloud.conf
  copy:
    content: ""
    dest: /sched/cyclecloud.conf
    owner: slurm 
    group: slurm 
    force: no

- name: symbolic link for cyclecloud.conf 
  file:
    src: /sched/cyclecloud.conf
    dest: /etc/slurm/cyclecloud.conf
    state: link

- name: initialize slurm autoscale config 
  shell: |
      /opt/cycle/slurm/cyclecloud_slurm.sh upgrade_conf 

- name: initialize slurm autoscale config 
  shell: |
      /opt/cycle/slurm/cyclecloud_slurm.sh create_nodes --policy AllowExisting 

- name: initialize slurm autoscale config 
  shell: |
      /opt/cycle/slurm/cyclecloud_slurm.sh slurm_conf > /sched/cyclecloud.conf 

- name: initialize slurm autoscale config 
  shell: |
      /opt/cycle/slurm/cyclecloud_slurm.sh gres_conf > /sched/gres.conf 

- name: initialize slurm autoscale config 
  shell: |
      /opt/cycle/slurm/cyclecloud_slurm.sh topology > /sched/topology.conf
  #args:
      #creates: /opt/cycle/jetpack/config/autoscale.json

- name: symbolic link for gres.conf 
  file:
    src: /sched/gres.conf
    dest: /etc/slurm/gres.conf
    state: link

- name: symbolic link for topology.conf 
  file:
    src: /sched/topology.conf
    dest: /etc/slurm/topology.conf
    state: link

- name: ensure slurmctld is running.
  service:
    name: slurmctld
    state: started
    enabled: yes

