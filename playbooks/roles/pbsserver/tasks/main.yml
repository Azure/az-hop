---

- name: Install dependencies
  yum:
    name: python3, nfs-utils

- name: Download pbspro 
  unarchive:
    src: https://github.com/PBSPro/pbspro/releases/download/v19.1.1/pbspro_19.1.1.centos7.zip
    dest: /mnt/resource
    remote_src: yes

- name: Install pbspro
  yum:
    name: 
      - /mnt/resource/pbspro_19.1.1.centos7/pbspro-server-19.1.1-0.x86_64.rpm
    state: present

- name: Install CC Jetpack
  yum:
    name: "https://lfswe.blob.core.windows.net/cycle/jetpack8-8.1.1-1423.x86_64.rpm?sp=r&st=2021-03-18T12:20:36Z&se=2021-03-19T20:20:36Z&spr=https&sv=2020-02-10&sr=b&sig=Qgn08ofcEn6VhnpREWnHgalN4VzbN5y9eW6M3al9psg%3D"

- name: Ensure pbs-server is running.
  service: 
    name: pbs
    state: started
    enabled: yes

- name: Prepare CC autoscale scripts dir
  file:
    path: /opt/cycle/jetpack/system/bootstrap/pbs
    state: directory
    mode: '0755'

- name: download pbs cc autoscale script 1 
  get_url: 
    url: "https://raw.githubusercontent.com/Azure/cyclecloud-pbspro/{{cc_pbs_version}}/specs/default/chef/site-cookbooks/pbspro/files/default/autostart.py"
    dest: /opt/cycle/jetpack/system/bootstrap/pbs/autostart.py
    mode: '755'

- name: download pbs cc autoscale script 2 
  get_url: 
    url: "https://raw.githubusercontent.com/Azure/cyclecloud-pbspro/{{cc_pbs_version}}/specs/default/chef/site-cookbooks/pbspro/files/default/autostart_hook.py"
    dest: /opt/cycle/jetpack/system/bootstrap/pbs/autostart_hook.py
    mode: '755'

- name: download pbs cc autoscale script 3
  get_url: 
    url: "https://raw.githubusercontent.com/Azure/cyclecloud-pbspro/{{cc_pbs_version}}/specs/default/chef/site-cookbooks/pbspro/files/default/logging_init.py"
    dest: /opt/cycle/jetpack/system/bootstrap/pbs/logging_init.py
    mode: '755'

- name: download pbs cc autoscale script 4 
  get_url: 
    url: "https://raw.githubusercontent.com/Azure/cyclecloud-pbspro/{{cc_pbs_version}}/specs/default/chef/site-cookbooks/pbspro/files/default/mockpbs.py"
    dest: /opt/cycle/jetpack/system/bootstrap/pbs/mockpbs.py
    mode: '755'

- name: download pbs cc autoscale script 5
  get_url: 
    url: "https://raw.githubusercontent.com/Azure/cyclecloud-pbspro/{{cc_pbs_version}}/specs/default/chef/site-cookbooks/pbspro/files/default/pbscc.py"
    dest: /opt/cycle/jetpack/system/bootstrap/pbs/pbscc.py
    mode: '755'
    
- name: download pbs cc autoscale script 6 
  get_url: 
    url: "https://raw.githubusercontent.com/Azure/cyclecloud-pbspro/{{cc_pbs_version}}/specs/default/chef/site-cookbooks/pbspro/files/default/submit_hook.py"
    dest: /opt/cycle/jetpack/system/bootstrap/pbs/submit_hook.py
    mode: '755'

- name: download pbs cc autoscale script 7 
  get_url: 
    url: "https://raw.githubusercontent.com/Azure/cyclecloud-pbspro/{{cc_pbs_version}}/specs/default/chef/site-cookbooks/pbspro/files/default/pbs_driver.py"
    dest: /opt/cycle/jetpack/system/bootstrap/pbs/pbs_driver.py
    mode: '755'

- name: copy tandem_driver files for cc autoscale 1/2
  copy:
    src: /opt/cycle/jetpack/system/chef/chef-repo/cookbooks/tandem/files/default/tandem_driver_main.py
    dest: /opt/cycle/jetpack/system/bootstrap/pbs/tandem_driver_main.py
    remote_src: yes

- name: copy tandem_driver files for cc autoscale 2/2
  copy:
    src: /opt/cycle/jetpack/system/chef/chef-repo/cookbooks/tandem/files/default/tandem_utils.py
    dest: /opt/cycle/jetpack/system/bootstrap/pbs/tandem_utils.py
    remote_src: yes
    
- name: cyclecloud connection config file
  copy: 
    content: | 
      {
      "cyclecloud": {
         "cluster": {
            "name": "pbs1"
         },
         "config": {
           "web_server": "https://ccportal:9443/cyclecloud",
           "username": "{{ cc_admin }}",
           "password": "{{ cc_password }}"
         }
       }
      }
    dest: /opt/cycle/jetpack/config/node.json

- name: submit_hook config file
  copy: 
    content: | 
      {
        "__comment__": "This file was generated by serializing node[:cyclecloud][:pbspro][:submit_hook].",
        "disable_eager_packing": true,
        "enabled": true,
        "logging": {
          "level": "INFO",
          "filename": "/var/spool/pbs/autoscale/submit_hook.log",
          "filemode": "a",
          "format": "%(asctime)s %(levelname)s %(message)s"
        }
      }
    dest: /opt/cycle/jetpack/system/bootstrap/pbs/submit_hook.json

- name: autostart config file
  copy: 
    content: | 
       {
         "__comment__": "This file was generated by serializing node[:cyclecloud][:pbspro][:autostart_hook].",
         "src_dirs": [
           "/opt/cycle/jetpack/system/embedded/lib/python3.8/site-packages",
           "/opt/cycle/jetpack/system/bootstrap/pbs"
         ],
         "cyclecloud_home": "/opt/cycle/jetpack",
         "autostart_log_level": "DEBUG",
         "autostart_log_file_level": "DEBUG",
         "cyclecloud.cluster.name": "pbs1"
       }
    dest: /opt/cycle/jetpack/system/bootstrap/pbs/autostart.json

#- name: enable pbs autoscale hook
#  shell: | 
#      /opt/pbs/bin/qmgr -c "create hook autoscale" 1>&2 || true
#      /opt/pbs/bin/qmgr -c "import hook autoscale application/x-python default /opt/cycle/jetpack/system/bootstrap/pbs/autostart_hook.py"
#      /opt/pbs/bin/qmgr -c "import hook autoscale application/x-config default /opt/cycle/jetpack/system/bootstrap/pbs/autostart.json"
#      /opt/pbs/bin/qmgr -c "set hook autoscale event = periodic"
#      /opt/pbs/bin/qmgr -c "set hook autoscale freq = 15"
#      /opt/pbs/bin/qmgr -c "create hook cycle_sub_hook" 2>/dev/null || true
#      /opt/pbs/bin/qmgr -c "set hook cycle_sub_hook event = queuejob" 2>/dev/null || true
#      /opt/pbs/bin/qmgr -c "create hook cycle_sub_periodic_hook" 2>/dev/null || true
#      /opt/pbs/bin/qmgr -c "set hook cycle_sub_periodic_hook event = periodic" 2>/dev/null || true
#      /opt/pbs/bin/qmgr -c "set hook cycle_sub_periodic_hook freq = 15"  2>/dev/null || true
#      /opt/pbs/bin/qmgr -c "import hook cycle_sub_hook application/x-python default /opt/cycle/jetpack/system/bootstrap/pbs/submit_hook.py"
#      /opt/pbs/bin/qmgr -c "import hook cycle_sub_hook application/x-config default /opt/cycle/jetpack/system/bootstrap/pbs/submit_hook.json"
#      /opt/pbs/bin/qmgr -c "import hook cycle_sub_periodic_hook application/x-python default /opt/cycle/jetpack/system/bootstrap/pbs/submit_hook.py"
#      /opt/pbs/bin/qmgr -c "import hook cycle_sub_periodic_hook application/x-config default /opt/cycle/jetpack/system/bootstrap/pbs/submit_hook.json"

- name: Add doqmgr pbs configuration script
  copy:
    src: '{{role_path}}/files/doqmgr.sh'
    dest: /var/spool/pbs/doqmgr.sh
    mode: '0755'
    
- name: Add pbs sched_config
  copy:
    src: '{{role_path}}/files/sched_config'
    dest: /var/spool/pbs/sched_priv/sched_config

- name: activate pbs config
  shell: /var/spool/pbs/doqmgr.sh 

- name: Restart pbs-server 
  service: 
    name: pbs
    state: restarted
