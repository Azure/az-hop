---

- name: Install dependencies
  yum:
    name: python3, nfs-utils

- name: Download pbspro 
  unarchive:
    src: https://github.com/PBSPro/pbspro/releases/download/v19.1.1/pbspro_19.1.1.centos7.zip
    dest: /mnt/resource
    remote_src: yes

- name: Install pbspro
  yum:
    name: 
      - /mnt/resource/pbspro_19.1.1.centos7/pbspro-server-19.1.1-0.x86_64.rpm
    state: present

- name: Install CC Jetpack
  yum:
    name: https://packages.microsoft.com/yumrepos/cyclecloud/jetpack8-8.1.0-1275.x86_64.rpm 

- name: Ensure pbs-server is running.
  service: 
    name: pbs
    state: started
    enabled: yes

- name: download CycleCloud ScaleLib PBSPro  
  unarchive: 
    src: "https://github.com/Azure/cyclecloud-pbspro/releases/download/2.0.0/cyclecloud-pbspro-pkg-2.0.0.tar.gz"
    dest: /tmp/
    remote_src: yes

- name: enable CycleCloud ScaleLib PBSPro
  shell: | 
    /tmp/cyclecloud-pbspro/initialize_pbs.sh 
    /tmp/cyclecloud-pbspro/initialize_default_queues.sh
    /tmp/cyclecloud-pbspro/install.sh  --venv /opt/cycle/pbspro/venv --install-venv
    /tmp/cyclecloud-pbspro/generate_autoscale_json.sh  --install-dir /opt/cycle/pbspro --username {{ cc_admin }} --password {{ cc_password }} --url https://ccportal:9443 --cluster-name pbs1
    sed -i '280s/resources:.*/resources: \"ncpus, mem, arch, host, vnode, aoe, slot_type, group_id, ungrouped, disk, ngpus, nodearray\"/' /var/spool/pbs/sched_priv/sched_config 
  args:
    chdir: /tmp/cyclecloud-pbspro

- name: Restart pbs-server 
  service: 
    name: pbs
    state: restarted
