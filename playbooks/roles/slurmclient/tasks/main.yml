---

- name: install epel
  yum: 
    name:
      - epel-release
    state: present

- name: install dependencies
  yum: 
    name:
      - jq, munge
    state: present

- name: install slurmd client utilities
  yum:
    name:
<<<<<<< HEAD
      -  '{{homedir_mountpoint}}/slurm/rpms/slurm-20.11.7-1.el7.x86_64.rpm'
=======
      -  /{{homedir_mountpoint}}/slurm/rpms/slurm-20.11.7-1.el7.x86_64.rpm
>>>>>>> 97aafb2b953087d40db18f7f30d37b59fa0a5dd1
    state: present

- name: check slurm config directory
  file:
    path: /etc/slurm
    state: directory

- name: add slurm group 
  group:
    name: slurm
    gid: 983
    state: present

- name: add slurm user
  user:
    name: slurm 
    group: slurm
    uid: 983
    state: present

- name: check local munge dir
  file:
    path: /etc/munge
    owner: munge
    group: munge
    mode: 0700
    state: directory

- name: install munge key
  copy:
<<<<<<< HEAD
    src: '{{homedir_mountpoint}}/slurm/config/munge.key'
=======
    src: /{{homedir_mountpoint}}/slurm/config/munge.key
>>>>>>> 97aafb2b953087d40db18f7f30d37b59fa0a5dd1
    remote_src: yes
    dest: /etc/munge/munge.key
    owner: munge
    group: munge
    mode: 0400

- name: ensure munge is running.
  service:
    name: munge 
    state: restarted
    enabled: yes

- name: create a symbolic link for slurm config dir
  file:
<<<<<<< HEAD
    src: '{{homedir_mountpoint}}/slurm/config'
=======
    src: /{{homedir_mountpoint}}/slurm/config
>>>>>>> 97aafb2b953087d40db18f7f30d37b59fa0a5dd1
    dest: /sched
    owner: slurm 
    group: slurm 
    state: link

- name: check slurmd log dir 
  file:
    path: /var/log/slurmd/
    mode: 0755
    owner: slurm 
    group: slurm 
    state: directory

- name: check slurmd spool dir 
  file:
    path: /var/spool/slurmd/
    mode: 0755
    owner: slurm 
    group: slurm 
    state: directory

- name: Create symlinks
  file:
    dest: /etc/slurm/{{item}}
    src: /sched/{{item}}
    state: link
    force: yes
  with_items:
    - slurm.conf
    - gres.conf
    - cgroup.conf
    - cyclecloud.conf
    - topology.conf
