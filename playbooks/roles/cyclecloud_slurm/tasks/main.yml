---
- name: Drop project files if they exists
  file:
    path: /root/slurm
    state: absent

- name: Create CycleCloud project
  command: '/usr/local/bin/cyclecloud project init slurm'
  args:
    chdir: '/root'
    creates: /root/slurm/project.ini

- name: Copy cluster-init files
  copy:
    src: '{{role_path}}/cluster-init'
    dest: /root/slurm/specs/default/

- name: Copy mountnfs file.
  template:
    src: '{{role_path}}/cluster-init/scripts/1-mountnfs.sh.j2'
    dest: /root/slurm/specs/default/cluster-init/scripts/1-mountnfs.sh
    mode: 0777

- name: Add lustre script 
  template:
    src: '{{role_path}}/cluster-init/scripts/2-mountlustre.sh.j2'
    dest: /root/slurm/specs/default/cluster-init/scripts/2-mountlustre.sh
    mode: 0777

- name: Add joindomain script 
  template:
    src: '{{role_path}}/cluster-init/scripts/3-joindomain.sh.j2'
    dest: /root/slurm/specs/default/cluster-init/scripts/3-joindomain.sh
    mode: 0777

- name: Add default script 
  template:
    src: '{{role_path}}/cluster-init/scripts/6-default.sh.j2'
    dest: /root/slurm/specs/default/cluster-init/scripts/6-default.sh
    mode: 0777

<<<<<<< HEAD
- name: Add installslurm script
=======
- name: Add slurm install script 
>>>>>>> a306f8b00c6920603dd9b90db6f837ff72b81e26
  template:
    src: '{{role_path}}/cluster-init/scripts/9-installslurm.sh.j2'
    dest: /root/slurm/specs/default/cluster-init/scripts/9-installslurm.sh
    mode: 0777

- name: Add telegraf configuration file  
  template:
    src: '{{role_path}}/cluster-init/files/telegraf.conf.j2'
    dest: /root/slurm/specs/default/cluster-init/files/telegraf.conf
    mode: 0600

- name: Remove Jinja files
  file:
    path: '{{item}}'
    state: absent
  with_items:
    - /root/slurm/specs/default/cluster-init/files/telegraf.conf.j2
    - /root/slurm/specs/default/cluster-init/scripts/1-mountnfs.sh.j2
    - /root/slurm/specs/default/cluster-init/scripts/2-mountlustre.sh.j2
    - /root/slurm/specs/default/cluster-init/scripts/3-joindomain.sh.j2
    - /root/slurm/specs/default/cluster-init/scripts/6-default.sh.j2
    - /root/slurm/specs/default/cluster-init/scripts/9-installslurm.sh.j2

- name: Create CycleCloud project
  command: '/usr/local/bin/cyclecloud project upload'
  args:
    chdir: '/root/slurm'

- name: Add Slurm-headless template
  template:
    src: 'slurm-headless.txt.j2'
    dest: /root/slurm-headless.txt

- name: Add Slurm-headless parameters
  template:
    src: slurm-headless.json.j2
    dest: /root/slurm1-parameters.json

- name: Import Slurm Cluster
  command: '/usr/local/bin/cyclecloud import_cluster slurm1 -f /root/slurm-headless.txt -p /root/slurm1-parameters.json -c Slurm-headless --force'

- name: Start Slurm Cluster
  command: '/usr/local/bin/cyclecloud start_cluster slurm1'
