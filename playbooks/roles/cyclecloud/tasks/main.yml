---
- name: Disable SELinux
  selinux:
    state: disabled

- name: Configure Cycle Cloud portal host
  script: '{{role_path}}/files/configure.py --useManagedIdentity --username {{cc_admin_user}} --acceptTerms --publickey "{{cc_public_key}}" --password "{{cc_password}}" --storageAccount {{cc_storage}}'

- name: Configure AD domain to connect to
  script: '{{role_path}}/files/configure_ad.py --url "ldap://{{cc_ad_server}}" --domain "@{{cc_domain}}"'

- name: Add User Role Record 
  copy:
    src: '{{role_path}}/files/user_role_record.txt'
    dest: /opt/cycle_server/config/data/user_role_record.txt

- name: Configure CycleCloud CLI
  command: '/usr/local/bin/cyclecloud initialize --force --batch --name ccportal --url=https://localhost:9443 --verify-ssl=false --username={{cc_admin_user}} --password="{{cc_password}}"'
  args:
    creates: /root/.cycle/config.ini

- name: Update "default locker" configuration cyclecloud-cli
  blockinfile:
    path: /root/.cycle/config.ini
    insertafter: "[cyclecloud]"
    block: |
      default_project_locker = azure-storage

- name: Create CycleCloud project
  command: '/usr/local/bin/cyclecloud project init pbs'
  args:
    chdir: '/root'
    creates: /root/pbs/project.ini

- name: Copy mountnfs file.
  template:
    src: 0-mountnfs.sh.j2
    dest: /root/pbs/specs/default/cluster-init/scripts/0-mountnfs.sh
    mode: 0777

- name: Add joindomain script 
  template:
    src: 1-joindomain.sh.j2
    dest: /root/pbs/specs/default/cluster-init/scripts/1-joindomain.sh
    mode: 0777

- name: Add installpbs script 
  copy:
    src: '{{role_path}}/files/2-installpbs.sh'
    dest: /root/pbs/specs/default/cluster-init/scripts/2-installpbs.sh

- name: Add cvmfs script 
  copy:
    src: '{{role_path}}/files/3-installcvmfs.sh'
    dest: /root/pbs/specs/default/cluster-init/scripts/3-installcvmfs.sh

- name: Add autostop script 
  copy:
    src: '{{role_path}}/files/4-autostop.sh'
    dest: /root/pbs/specs/default/cluster-init/scripts/4-autostop.sh

- name: Add autostop node script 
  copy:
    src: '{{role_path}}/files/autostop.rb'
    dest: /root/pbs/specs/default/cluster-init/files/autostop.rb

- name: Add healthcheck node script 
  copy:
    src: '{{role_path}}/files/check_stuff.sh'
    dest: /root/pbs/specs/default/cluster-init/files/check_stuff.sh

- name: Add healthchecks.json file 
  copy:
    src: '{{role_path}}/files/healthchecks.json'
    dest: /root/pbs/specs/default/cluster-init/files/healthchecks.json

- name: Add healthcheck node script 
  copy:
    src: '{{role_path}}/files/1-healthcheck.sh'
    dest: /root/pbs/specs/default/cluster-init/scripts/1-healthcheck.sh

- name: Add telegraf configuration file  
  template:
    src: telegraf.conf.j2
    dest: /root/pbs/specs/default/cluster-init/files/telegraf.conf

- name: Add telegraf setup script 
  copy:
    src: '{{role_path}}/files/5-install-telegraf.sh'
    dest: /root/pbs/specs/default/cluster-init/scripts/5-install-telegraf.sh

- name: Add default script 
  copy:
    src: '{{role_path}}/files/6-default.sh'
    dest: /root/pbs/specs/default/cluster-init/scripts/6-default.sh

- name: Create CycleCloud project
  command: '/usr/local/bin/cyclecloud project upload'
  args:
    chdir: '/root/pbs'

- name: Add PBS-headless template
  template:
    src: 'pbs-headless.txt.j2'
    dest: /root/pbs-headless.txt

- name: Add PBS-headless parameters
  template:
    src: pbs-headless.json.j2
    dest: /root/pbs1-parameters.json

- name: Import PBS Cluster
  command: '/usr/local/bin/cyclecloud import_cluster pbs1 -f /root/pbs-headless.txt -p /root/pbs1-parameters.json -c OpenPBS-headless --force'

- name: Start PBS Cluster
  command: '/usr/local/bin/cyclecloud start_cluster pbs1'

- name: Update CC CycleCloud
  yum:
    name: "https://lfswe.blob.core.windows.net/cycle/cyclecloud8-8.1.1-1423.x86_64.rpm?sp=r&st=2021-03-18T14:54:06Z&se=2021-08-03T21:54:06Z&spr=https&sv=2020-02-10&sr=b&sig=XZdLxsWS6Xr9a16H7sfFy9Kid3XxuPOVRfts7Bf4oEg%3D"

- name: Update CC Jetpack
  yum:
    name: "https://lfswe.blob.core.windows.net/cycle/jetpack8-8.1.1-1423.x86_64.rpm?sp=r&st=2021-03-18T14:55:02Z&se=2021-03-18T22:55:02Z&spr=https&sv=2020-02-10&sr=b&sig=hfFW5QupK0aWBuh71koiMVIfay9S3covxKheFQfOKt8%3D"

- name: Update cycle server properties
  shell: |
    sed -i 's/^webServerContextPath=.*$/webServerContextPath=\/cyclecloud/g;s/^webServerRedirectHttp=.*$/webServerRedirectHttp=false/g' /opt/cycle_server/config/cycle_server.properties
    /opt/cycle_server/cycle_server restart
