---
- name: Disable SELinux
  selinux:
    state: disabled

- name: Configure Cycle Cloud portal host
  script: '{{role_path}}/files/configure.py --useManagedIdentity --username {{cc_admin_user}} --acceptTerms --publickey "{{cc_public_key}}" --password "{{cc_password}}" --storageAccount {{cc_storage}}'

- name: Configure CycleCloud CLI
  command: '/usr/local/bin/cyclecloud initialize --force --batch --name ccportal --url=https://localhost:9443 --verify-ssl=false --username={{cc_admin_user}} --password="{{cc_password}}"'
  args:
    creates: /root/.cycle/config.ini

- name: Update "default locker" configuration cyclecloud-cli
  blockinfile:
    path: /root/.cycle/config.ini
    insertafter: "[cyclecloud]"
    block: |
      default_project_locker = azure-storage

- name: Create CycleCloud project
  command: '/usr/local/bin/cyclecloud project init pbs'
  args:
    chdir: '/root'
    creates: /root/pbs/project.ini

- name: Copy mountnfs file.
  template:
    src: 0-mountnfs.sh.j2
    dest: /root/pbs/specs/default/cluster-init/scripts/0-mountnfs.sh
    mode: 0777

- name: Add joindomain script 
  template:
    src: 1-joindomain.sh.j2
    dest: /root/pbs/specs/default/cluster-init/scripts/1-joindomain.sh
    mode: 0777

- name: Add installpbs script 
  copy:
    src: '{{role_path}}/files/2-installpbs.sh'
    dest: /root/pbs/specs/default/cluster-init/scripts/2-installpbs.sh

- name: Add cvmfs script 
  copy:
    src: '{{role_path}}/files/3-installcvmfs.sh'
    dest: /root/pbs/specs/default/cluster-init/scripts/3-installcvmfs.sh

- name: Add autostop script 
  copy:
    src: '{{role_path}}/files/4-autostop.sh'
    dest: /root/pbs/specs/default/cluster-init/scripts/4-autostop.sh

- name: Add autostop node script 
  copy:
    src: '{{role_path}}/files/autostop.rb'
    dest: /root/pbs/specs/default/cluster-init/files/autostop.rb

- name: Add telegraf configuration file  
  template:
    src: telegraf.conf.j2
    dest: /root/pbs/specs/default/cluster-init/files/telegraf.conf

- name: Add telegraf setup script 
  copy:
    src: '{{role_path}}/files/5-install-telegraf.sh'
    dest: /root/pbs/specs/default/cluster-init/scripts/5-install-telegraf.sh

- name: Create CycleCloud project
  command: '/usr/local/bin/cyclecloud project upload'
  args:
    chdir: '/root/pbs'

- name: Add PBS-headless template
  template:
    src: 'pbs-headless.txt.j2'
    dest: /root/pbs-headless.txt

- name: Add PBS-headless parameters
  template:
    src: pbs-headless.json.j2
    dest: /root/pbs1-parameters.json

- name: Import PBS Cluster
  command: '/usr/local/bin/cyclecloud import_cluster pbs1 -f /root/pbs-headless.txt -p /root/pbs1-parameters.json -c OpenPBS-headless --force'

- name: Start PBS Cluster
  command: '/usr/local/bin/cyclecloud start_cluster pbs1'

