---
- name: Disable SELinux
  selinux:
    state: disabled
  register: selinux

# - name: reboot 
#   reboot:
#   when: selinux.reboot_required 

- name: install AZ CLI repo (CentOS)
  shell: |
    set -e
    rpm --import https://packages.microsoft.com/keys/microsoft.asc
    cat > /etc/yum.repos.d/azure-cli.repo <<EOF
    [azure-cli]
    name=Azure CLI
    baseurl=https://packages.microsoft.com/yumrepos/azure-cli
    enabled=1
    gpgcheck=1
    gpgkey=https://packages.microsoft.com/keys/microsoft.asc
    EOF
  args:
    creates: /etc/yum.repos.d/azure-cli.repo

- name: install CycleCloud repo
  shell: |
    cat > /etc/yum.repos.d/cyclecloud.repo <<EOF
    [cyclecloud]
    name=cyclecloud
    baseurl=https://packages.microsoft.com/yumrepos/cyclecloud
    gpgcheck=1
    gpgkey=https://packages.microsoft.com/keys/microsoft.asc
    EOF
  args:
    creates: /etc/yum.repos.d/cyclecloud.repo

- name: Install epel-release
  yum:
    name: epel-release
    state: present
    lock_timeout : 180

- name: Install pre-reqs packages
  yum:
    name: azure-cli, dnsmasq, unzip, gcc, openssl-devel, bzip2-devel, libffi-devel, zlib-devel, openssl11, openssl11-libs, openssl11-devel
    state: present
    lock_timeout : 180

- name: download Python 3.9  
  unarchive: 
    src: "https://www.python.org/ftp/python/3.9.18/Python-3.9.18.tgz"
    dest: /tmp/
    remote_src: yes
  args:
    creates: /usr/local/bin/python3.9

- name: Build Python 3.9
  shell: |
    set -e
    cd /tmp/Python-3.9.18
    ./configure --enable-optimizations
    make altinstall
  args:
    creates: /usr/local/bin/python3.9

- name: Upgrade PIP
  shell: |
    set -e
    alternatives --install /usr/bin/python3 python3 /usr/local/bin/python3.9 1
    python3 -m pip install --upgrade pip

- name: Install CycleCloud
  yum:
    name: "cyclecloud8-{{cyclecloud_version}}"
    state: present
    lock_timeout : 180

- name: Install Jetpack
  yum:
    name: "jetpack8-{{cyclecloud_version}}"
    state: present
    lock_timeout : 180
