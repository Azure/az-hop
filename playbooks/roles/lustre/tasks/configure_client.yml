---
- name: Gather the package facts
  package_facts:
    manager: auto

- name: Remove Lustre client if it is not from AMLFS repo
  yum:
    name: lustre-client
    state: absent
    lock_timeout : 180

- name: Check whether a package called amlfs-lustre-client is installed
  ansible.builtin.debug:
    msg: "{{ ansible_facts.packages['amlfs-lustre-client'] | length }} versions of amlfs-lustre-client are installed!"
  when: "'amlfs-lustre-client' in ansible_facts.packages"

- name: Disable SELinux
  selinux:
    state: disabled

# Source: https://learn.microsoft.com/en-us/azure/azure-managed-lustre/install-rhel-7
- name: Install Lustre client from AMLFS repo
  block:
    - name: add AMLFS repo
      shell: |
        rpm --import https://packages.microsoft.com/keys/microsoft.asc
        DISTRIB_CODENAME=el7
        REPO_PATH=/etc/yum.repos.d/amlfs.repo
        echo -e "[amlfs]" > ${REPO_PATH}
        echo -e "name=Azure Lustre Packages" >> ${REPO_PATH}
        echo -e "baseurl=https://packages.microsoft.com/yumrepos/amlfs-${DISTRIB_CODENAME}" >> ${REPO_PATH}
        echo -e "enabled=1" >> ${REPO_PATH}
        echo -e "gpgcheck=1" >> ${REPO_PATH}
        echo -e "gpgkey=https://packages.microsoft.com/keys/microsoft.asc" >> ${REPO_PATH}
    - name: install Lustre client
      shell: yum install amlfs-lustre-client-2.15.1_24_gbaa21ca-$(uname -r | sed -e "s/\.$(uname -p)$//" | sed -re 's/[-_]/\./g')-1
  when: "'amlfs-lustre-client' not in ansible_facts.packages"
