- hosts: jumpbox
  gather_facts: yes
  become: true
  tasks:

  - name: Install InfluxDB
    include_role:
      name: influxdb
    vars:
      influxdb_username: "{{global_admin_username}}"
      influxdb_password: "{{global_cc_password}}"
      influxdb_database_name: "telegraf"

  - name: Install Grafana
    include_role:
      name: grafana
    vars:
      grafana_fqdn: localhost
      grafana_admin_user: "{{global_admin_username}}"
      grafana_admin_password: "{{global_cc_password}}"
      grafana_ldap_server: "{{ad_dns}}"
      grafana_server_root_url: "%(protocol)s://%(domain)s:%(http_port)s/rnode/jumpbox/%(http_port)s/"
      grafana_auth_ldap_enabled: true
      grafana_public_facing_domain_name: localhost
      grafana_datasources: # https://grafana.com/docs/grafana/latest/administration/provisioning/#data-sources
        - name: "azhpc"
          type: "influxdb"
          access: "proxy"
          database: "telegraf"
          user: "{{global_admin_username}}"
          password: "{{global_cc_password}}"
          url: http://localhost:8086
          jsonData:
            httpMode: GET
      grafana_dashboards: # https://grafana.com/docs/grafana/latest/administration/provisioning/#dashboards
        - name: azhpc
          type: file
          disableDeletion: false
          updateIntervalSeconds: 30
          editable: true
          allowUiUpdates: true
          options:
            path: /etc/grafana/provisioning/dashboards
            foldersFromFilesStructure: true

  - name: Copy dashboard
    copy:
      src: 'dashboard.json'
      dest: '/etc/grafana/provisioning/dashboards/dashboard.json'

