---
- name: prep socks tunnel
  hosts: localhost
  connection: local
  gather_facts: no
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - name: start socks tunnel  
    shell: ssh -i {{ lookup('env', 'PWD') }}/{{ansible_ssh_private_key_file}} -fN -D localhost:5985 -o StrictHostKeyChecking=no {{admin_user}}@{{ psrp_ssh_proxy }}

- name: Configure Windows Viz client 
  hosts: win
  vars_files:
    - '{{global_config_file}}'

  tasks:
  - name: Read Password from KV
    command: az keyvault secret show --vault-name {{key_vault}} -n {{admin_user}}-password --query "value" -o tsv
    delegate_to: localhost 
    connection: local
    register: ad_join_password

  - name: Set multiple lookup addresses on all visible adapters (usually physical adapters that are in the Up state), with debug logging to a file
    ansible.windows.win_dns_client:
      adapter_names: '*'
      dns_servers:
        - 10.0.1.4
      log_path: C:\dns_log.txt

  - ansible.windows.win_domain_membership:
      dns_domain_name: '{{ad_join_domain}}' 
      hostname: win
      domain_admin_user: hpcadmin@hpc.azure
      domain_admin_password: '{{ad_join_password.stdout}}' 
      state: domain
    register: domain_state

  - ansible.windows.win_reboot:
    when: domain_state.reboot_required

- name: close socks tunnel
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
  - name: close session on local port
    shell: ps aux | grep localhost:5985 | grep -v grep | awk '{print "kill -9 " $2}' | sh
    ignore_errors: true
