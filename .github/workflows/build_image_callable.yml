#
# Copyright (c) Microsoft Corporation
# Licensed under the MIT License.
#
name : build_image_callable

on:
  pull_request

jobs:
  build_image:
    name: build_image
    runs-on: self-hosted
 
    steps:
      - name: Setup upterm session
        uses: lhotari/action-upterm@v1        
      - name: Login azure
        run: |
          source miniconda/bin/activate
          az login --service-principal -u '${{ env.ARM_CLIENT_ID }}' -p '${{ env.ARM_CLIENT_SECRET }}' --tenant '${{ env.ARM_TENANT_ID }}'
          az account set -s  ${{ env.ARM_SUBSCRIPTION_ID }}

      - name: Build Images
        run: |
          source /miniconda/bin/activate
          RESOURCE_GROUP=${{ inputs.resource_group }}
          ./azhop_state.sh download ${{ env.AZHOP_STATE_ACCOUNT }} ${{ env.AZHOP_STATE_CONTAINER }} $RESOURCE_GROUP
          cd packer
          ./build_image.sh -i ${{matrix.packer_file}}.json
