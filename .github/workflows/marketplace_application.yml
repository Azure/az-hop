#
# Copyright (c) Microsoft Corporation
# Licensed under the MIT License.
#
name : marketplace application
on:
  pull_request:
    types: [ closed ]
    branches:
      - main
    paths:
      - 'bicep/**'
      - 'marketplace/solution/**'
  workflow_dispatch:

env:
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}

defaults:
  run:
    shell: bash

jobs:
  arm_validation:
    runs-on: ubuntu-latest

    container:
      image: azhop.azurecr.io/hpcrover:2306.0708
      credentials:
        username: ${{ env.ARM_CLIENT_ID }}
        password: ${{ env.ARM_CLIENT_SECRET }}
      options: --user 0

    steps:
      - uses: actions/checkout@v4

      - name: Build ARM
        id: build
        run: |
          set -e
          source /miniconda/bin/activate
          ./marketplace/solution/build.sh

      - name: Run ARM-TTK
        uses: venura9/arm-ttk@master
        id: bicep
        with: 
          path: marketplace/solution/build
          file: mainTemplate.json

      - name: Results for Run ARM-TTK
        run: |
          content=${{ steps.bicep.outputs.results }}
          echo "Results $content"
